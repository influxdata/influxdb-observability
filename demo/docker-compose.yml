services:

  jaeger-query:
    image: jaegertracing/jaeger-query:1.45
    stop_grace_period: 10s
    ports:
    - "16686:16686" # web UI
    depends_on:
    - jaeger-influxdb
    environment:
      LOG_LEVEL: info
      SPAN_STORAGE_TYPE: grpc-plugin
      GRPC_STORAGE_SERVER: jaeger-influxdb:17271
      GRPC_STORAGE_CONNECTION_TIMEOUT: 30s
      QUERY_HTTP_SERVER_HOST_PORT: :16686
      ADMIN_HTTP_HOST_PORT: :16687
      QUERY_UI_CONFIG: /jaeger-ui-config.json
    volumes:
    - ./jaeger-ui-config.json:/jaeger-ui-config.json:ro

  jaeger-influxdb:
    image: jacobmarble/jaeger-influxdb:0.5.2
    stop_grace_period: 10s
    environment:
      LOG_LEVEL: info
      LISTEN_ADDR: :17271
      INFLUXDB_TIMEOUT: 30s
      # required: hostname or hostname:port
      INFLUXDB_ADDR: host.containers.internal:8082
      # required: bucket name
      INFLUXDB_BUCKET: otel_otel
      # optional: bucket name for archived traces
      INFLUXDB_BUCKET_ARCHIVE:
      # required
      INFLUXDB_TOKEN: xxx
      INFLUXDB_TLS_DISABLE: "true"

  hotrod:
    image: jaegertracing/example-hotrod:1.41
    stop_grace_period: 1s
    ports:
    - "8090:8080" # web UI
    depends_on:
    - otelcol-influxdb
    environment:
      JAEGER_AGENT_HOST: otelcol-influxdb
      JAEGER_AGENT_PORT: 6831

  otelcol-influxdb:
    image: otel/opentelemetry-collector-contrib:0.79.0
    command: [ "--config", "/config.yml" ]
    stop_grace_period: 10s
    volumes:
    - ./otelcol-config.yml:/config.yml:ro

  # if you need to debug network stuff:
  # debug:
  #   image: nixery.dev/shell/findutils/gnugrep/gnutar/hexdump/less/mount/procps/curl/grpcurl/binutils/gdb/lldb/strace/rustc/linuxpackages.perf/perf-tools/gzip/zstd/tcpdump/netcat-openbsd
  #   # network_mode: "slirp4netns:allow_host_loopback=true"
  #   command:
  #     - /bin/bash
  #     - -c
  #     - --
  #     - while true; do sleep 30; done;
